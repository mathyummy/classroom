<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>九年八班 數位資訊看板 - 雲端版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'classroom-908-board';

        const DATES = { 
            exam: "2026-01-21", 
            mock: "2026-03-03",
            final: "2026-05-16" 
        };

        const defaultData = {
            marquee: "九年八班雲端看板已啟動！點擊區塊即可編輯內容。",
            marqueeSpeed: "25s",
            homework: "1. 國文講義 P.35-P.40\n2. 英文單字 L5 小考 (明天)\n3. 數學習作 3-1 完工",
            missing: [
                { subject: "數學", students: [{id: "03", done: false}, {id: "15", done: false}] }
            ],
            important: "1. 視力檢查：明天 08:30。\n2. 記得帶環保餐具。",
            quote: "「努力不一定成功，但不努力一定很輕鬆。」",
            timerPreset: 300,
            isMuted: false
        };

        let appData = { ...defaultData };
        let user = null;

        const getDataDocRef = () => doc(db, 'artifacts', appId, 'public', 'data', 'boardConfig', 'mainBoard');

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) { console.error("Auth Error:", error); }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                setupSync();
                document.getElementById('user-id-display').textContent = `ID: ${user.uid.substring(0,6)}`;
            }
        });

        const setupSync = () => {
            const dataDocRef = getDataDocRef();
            onSnapshot(dataDocRef, (snapshot) => {
                if (snapshot.exists()) {
                    appData = snapshot.data();
                    renderBoard();
                } else {
                    setDoc(dataDocRef, defaultData);
                }
            }, (error) => console.error("Sync Error:", error));
        };

        window.saveToCloud = async (newData) => {
            if (!user) return;
            const dataDocRef = getDataDocRef();
            try { await updateDoc(dataDocRef, newData); } 
            catch (error) { await setDoc(dataDocRef, newData, { merge: true }); }
        };

        const renderBoard = () => {
            document.getElementById('marquee-content').textContent = appData.marquee || "";
            document.getElementById('homework-list').textContent = appData.homework || "";
            document.getElementById('important-note').textContent = appData.important || "";
            document.getElementById('quote-display').textContent = appData.quote || "";
            
            // 處理跑馬燈速度顯示
            const mContent = document.getElementById('marquee-content');
            const speed = appData.marqueeSpeed || "25s";
            const speedLabel = document.getElementById('speed-label');
            
            const labels = { "25s": "正常", "40s": "慢速", "15s": "極快", "0s": "停止" };
            speedLabel.textContent = labels[speed] || "正常";

            if (speed === "0s") {
                mContent.style.animation = "none";
                mContent.style.transform = "none";
                mContent.className = "text-lg font-bold px-4";
            } else {
                mContent.style.animation = `marquee ${speed} linear infinite`;
                mContent.className = "animate-marquee text-lg font-bold";
            }
            
            const missingContainer = document.getElementById('missing-container');
            missingContainer.innerHTML = '';
            
            if (!appData.missing || appData.missing.length === 0) {
                missingContainer.innerHTML = '<div class="text-emerald-400 font-bold text-center py-6">★ 全部交齊 ★</div>';
            } else {
                appData.missing.forEach((group, gIndex) => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = "bg-slate-800/60 p-4 rounded-2xl border border-slate-700/50 mb-3 shadow-inner";
                    groupDiv.innerHTML = `<div class="text-lg font-black text-orange-300 mb-2 border-b border-orange-500/20 pb-1">${group.subject}</div>`;
                    const list = document.createElement('div');
                    list.className = "flex flex-wrap gap-2 pt-1";
                    group.students.forEach((s, sIndex) => {
                        const tag = document.createElement('div');
                        tag.className = `px-3 py-1 border-2 rounded-lg font-mono font-black text-xl cursor-pointer transition-all ${s.done ? 'opacity-20 line-through bg-slate-700 border-transparent' : 'text-orange-100 border-orange-500/40 bg-orange-500/10 hover:scale-110'}`;
                        tag.textContent = s.id;
                        tag.onclick = (e) => {
                            e.stopPropagation();
                            const updatedMissing = JSON.parse(JSON.stringify(appData.missing));
                            updatedMissing[gIndex].students[sIndex].done = !updatedMissing[gIndex].students[sIndex].done;
                            window.saveToCloud({ missing: updatedMissing });
                        };
                        list.appendChild(tag);
                    });
                    groupDiv.appendChild(list);
                    missingContainer.appendChild(groupDiv);
                });
            }
            updateMuteUI();
            updateCountdowns();
        };

        const updateCountdowns = () => {
            const calc = (t) => {
                const diff = new Date(t).setHours(0,0,0,0) - new Date().setHours(0,0,0,0);
                return Math.max(0, Math.ceil(diff / 86400000));
            };
            document.getElementById('exam-countdown').textContent = calc(DATES.exam);
            document.getElementById('mock-countdown').textContent = calc(DATES.mock);
            document.getElementById('final-countdown').textContent = calc(DATES.final);
        };

        setInterval(() => {
            const now = new Date();
            document.getElementById('clock-display').textContent = now.toLocaleTimeString('zh-TW', {hour12:false});
            document.getElementById('date-display').textContent = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        }, 1000);

        window.toggleMarqueeSpeed = (e) => {
            e.stopPropagation();
            const speeds = { "25s": "40s", "40s": "15s", "15s": "0s", "0s": "25s" };
            const next = speeds[appData.marqueeSpeed || "25s"];
            window.saveToCloud({ marqueeSpeed: next });
        };

        window.openModal = (field, title, desc = "") => {
            window.currentEditingField = field;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-desc').innerHTML = desc;
            let val = field === 'missing' ? (appData.missing || []).map(g => `${g.subject}：${g.students.map(s => s.id).join(', ')}`).join(' | ') : (appData[field] || "");
            document.getElementById('modal-input').value = val;
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('edit-modal').classList.add('hidden');

        window.confirmSave = () => {
            const val = document.getElementById('modal-input').value.trim();
            const update = {};
            if (window.currentEditingField === 'missing') {
                if (!val) update.missing = [];
                else {
                    update.missing = val.split('|').map(g => {
                        const parts = g.split(/[：:]/);
                        const sub = (parts[0] || "其他").trim();
                        const students = (parts[1] || "").split(/[,，\s]+/).filter(x => x.trim()).map(id => ({ id: id.trim(), done: false }));
                        return { subject: sub, students };
                    }).filter(g => g.students.length > 0);
                }
            } else { update[window.currentEditingField] = val; }
            window.saveToCloud(update);
            closeModal();
        };

        window.toggleMute = () => window.saveToCloud({ isMuted: !appData.isMuted });
        function updateMuteUI() {
            const icon = document.getElementById('mute-icon');
            icon.className = appData.isMuted ? 'fas fa-volume-mute text-rose-500' : 'fas fa-volume-up text-emerald-400';
        }

        window.spin = () => {
            const el = document.getElementById('lucky-num');
            const icon = document.getElementById('spin-icon');
            if(icon.classList.contains('fa-spin')) return;
            icon.classList.add('fa-spin');
            let count = 0;
            const intv = setInterval(() => {
                el.textContent = Math.floor(Math.random() * 25) + 1;
                if (++count > 15) { clearInterval(intv); icon.classList.remove('fa-spin'); }
            }, 80);
        };

        initAuth();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=JetBrains+Mono:wght@700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0f172a; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .editable:hover { background: rgba(255,255,255,0.05); cursor: pointer; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .animate-marquee { display: inline-block; white-space: nowrap; animation: marquee 25s linear infinite; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="p-4 space-y-4">

    <!-- 編輯彈窗 -->
    <div id="edit-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-lg rounded-3xl p-6 shadow-2xl">
            <h3 id="modal-title" class="text-xl font-bold mb-2 text-blue-400">編輯內容</h3>
            <div id="modal-desc" class="text-slate-400 text-xs mb-4 leading-relaxed"></div>
            <textarea id="modal-input" class="w-full h-40 bg-slate-800 border border-slate-600 rounded-xl p-4 text-white focus:outline-none focus:border-blue-500 text-lg mb-4 font-mono"></textarea>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3 bg-slate-700 rounded-xl font-bold">取消</button>
                <button onclick="confirmSave()" class="flex-1 py-3 bg-blue-600 rounded-xl font-bold">同步到雲端</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass rounded-2xl p-4 flex flex-col lg:flex-row justify-between items-center shadow-xl border-b-2 border-indigo-500/20">
        <div class="flex items-center space-x-4">
            <div class="bg-indigo-600 p-2 rounded-lg shadow-lg shadow-indigo-900/40 shrink-0"><i class="fas fa-cloud text-xl"></i></div>
            <div>
                <div class="flex items-center gap-3">
                    <h1 class="text-2xl font-black tracking-tight text-white whitespace-nowrap">九年八班 數位資訊看板</h1>
                    <div class="flex items-center bg-slate-800/80 px-2 py-1 rounded-lg border border-slate-700 gap-2">
                        <span id="user-id-display" class="text-slate-500 text-[10px] font-mono">ID: ...</span>
                        <div class="flex items-center text-[10px] text-emerald-500 font-bold whitespace-nowrap">
                            <span class="mr-1.5 hidden sm:inline">雲端同步中</span>
                            <i class="fas fa-circle text-[6px] animate-pulse"></i>
                        </div>
                    </div>
                </div>
                <div id="date-display" class="text-indigo-300 text-sm font-bold">正在讀取日期...</div>
            </div>
        </div>

        <div class="flex flex-wrap justify-center gap-3 mt-4 lg:mt-0">
            <div class="bg-yellow-500/10 border border-yellow-500/30 px-3 py-1 rounded-xl text-center">
                <div class="text-[10px] text-yellow-500 font-bold">段考倒數</div>
                <div class="text-2xl font-black text-yellow-400"><span id="exam-countdown">--</span><span class="text-xs ml-1 font-normal opacity-60">D</span></div>
            </div>
            <div class="bg-blue-600/10 border border-blue-500/30 px-3 py-1 rounded-xl text-center">
                <div class="text-[10px] text-blue-400 font-bold">模擬考倒數</div>
                <div class="text-2xl font-black text-blue-400"><span id="mock-countdown">--</span><span class="text-xs ml-1 font-normal opacity-60">D</span></div>
            </div>
            <div class="bg-orange-600/10 border border-orange-500/30 px-3 py-1 rounded-xl text-center">
                <div class="text-[10px] text-orange-400 font-bold">會考倒數</div>
                <div class="text-2xl font-black text-orange-500"><span id="final-countdown">--</span><span class="text-xs ml-1 font-normal opacity-60">D</span></div>
            </div>
            <div class="ml-4 pl-4 border-l border-slate-700 flex flex-col justify-center">
                <span id="clock-display" class="text-3xl font-mono font-black text-indigo-400 tracking-tighter">00:00:00</span>
            </div>
        </div>
    </header>

    <!-- Marquee -->
    <div onclick="openModal('marquee', '編輯跑馬燈公告')" class="bg-rose-600 rounded-xl h-11 flex items-center overflow-hidden shadow-lg editable group">
        <button onclick="toggleMarqueeSpeed(event)" class="bg-rose-950 hover:bg-rose-900 px-4 h-full flex items-center z-10 border-r border-rose-400/30 transition-colors shrink-0 group/btn">
            <div class="flex flex-col items-center">
                <i class="fas fa-gauge-high text-xs mb-0.5 text-rose-300 group-hover/btn:scale-110 transition-transform"></i>
                <span id="speed-label" class="text-[10px] font-black tracking-tighter text-white">正常</span>
            </div>
        </button>
        <div class="flex-1 overflow-hidden relative">
            <div id="marquee-content" class="animate-marquee text-lg font-bold">載入公告中...</div>
        </div>
        <div class="hidden group-hover:block absolute right-2 bg-rose-900/80 px-2 py-0.5 rounded text-[10px]">點擊修改文字</div>
    </div>

    <!-- Main Content -->
    <main class="grid grid-cols-1 md:grid-cols-3 gap-4 flex-1 min-h-0">
        <!-- Homework -->
        <section onclick="openModal('homework', '今日聯絡簿', '每一行會自動變成一個清單項目')" class="glass rounded-3xl p-6 flex flex-col border-l-8 border-l-yellow-400 editable group">
            <h2 class="text-2xl font-black text-yellow-400 mb-4 flex items-center">
                <i class="fas fa-edit mr-3"></i> 今日聯絡簿
            </h2>
            <div id="homework-list" class="text-2xl leading-relaxed whitespace-pre-wrap overflow-y-auto flex-1 custom-scrollbar font-bold text-slate-100"></div>
            <!-- 今日佳句色彩優化 -->
            <div onclick="event.stopPropagation(); openModal('quote', '今日佳句')" class="mt-4 p-3 bg-slate-800/50 rounded-xl border border-slate-700/50">
                <i class="fas fa-quote-left mr-2 opacity-70 text-yellow-300"></i>
                <span id="quote-display" class="italic text-yellow-300 text-lg font-bold"></span>
            </div>
        </section>

        <!-- Important -->
        <section onclick="openModal('important', '重要提醒', '建議分點列出，內容會自動換行')" class="bg-blue-600/20 glass rounded-3xl p-6 flex flex-col border-t-8 border-t-blue-400 editable">
            <h2 class="text-2xl font-black text-blue-300 mb-4 flex items-center">
                <i class="fas fa-bullhorn mr-3"></i> 重要提醒
            </h2>
            <div id="important-note" class="text-2xl font-black leading-relaxed whitespace-pre-wrap overflow-y-auto flex-1 custom-scrollbar text-blue-50"></div>
        </section>

        <!-- Missing -->
        <section class="glass rounded-3xl p-6 flex flex-col border-r-8 border-r-orange-500">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-black text-orange-400"><i class="fas fa-user-times mr-3"></i> 作業未交</h2>
                <button onclick="openModal('missing', '編輯未交名單', '<b>輸入範例：</b><br>數學：01, 05 | 英文：12, 13, 20')" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-lg transition-colors border border-slate-600">
                    <i class="fas fa-plus mr-1"></i> 編輯科目
                </button>
            </div>
            <div id="missing-container" class="flex-1 overflow-y-auto custom-scrollbar pr-1"></div>
        </section>
    </main>

    <!-- Footer Tools -->
    <footer class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-4 shrink-0 pb-2">
        <!-- Picker -->
        <div class="glass rounded-2xl p-3 flex items-center justify-between shadow-lg h-20 border border-indigo-500/20">
            <div>
                <p class="text-indigo-400 text-[10px] font-bold uppercase mb-1 tracking-widest">Lucky Spin</p>
                <div id="lucky-num" class="text-4xl font-black text-white">?</div>
            </div>
            <button onclick="spin()" class="bg-indigo-600 p-4 rounded-xl hover:scale-105 transition-transform shadow-lg shadow-indigo-900/50">
                <i id="spin-icon" class="fas fa-random text-white"></i>
            </button>
        </div>

        <!-- Timer -->
        <div class="glass rounded-2xl p-3 flex items-center justify-between shadow-lg h-20 border border-emerald-500/20">
            <div class="flex-1">
                <div class="flex items-center space-x-2">
                    <p class="text-emerald-400 text-[10px] font-bold uppercase tracking-widest">Timer</p>
                    <button onclick="toggleMute()" class="focus:outline-none"><i id="mute-icon" class="fas fa-volume-up text-[10px]"></i></button>
                </div>
                <div id="timer-display" class="text-3xl font-mono font-bold text-emerald-400">05:00</div>
            </div>
            <button class="bg-emerald-600 px-3 py-2 rounded-xl font-bold text-xs text-white shadow-lg shadow-emerald-900/50">START</button>
        </div>

        <!-- Links 1: Padlet -->
        <div class="glass rounded-2xl p-2 flex flex-col justify-center shadow-lg h-20 border border-slate-700">
            <a href="https://padlet.com/teacher133_5/padlet-rmnqtuy0xqgy53qh" target="_blank" class="h-full w-full bg-indigo-900/40 hover:bg-indigo-600 rounded-xl flex items-center justify-center gap-3 transition-colors border border-indigo-500/20 px-4 group">
                <div class="bg-indigo-500 p-2 rounded-lg group-hover:scale-110 transition-transform"><i class="fas fa-clipboard-list text-white"></i></div>
                <span class="text-sm font-black text-white">908電子布告欄</span>
            </a>
        </div>

        <!-- Links 2: 宜昌國中官網 (新區塊) -->
        <div class="glass rounded-2xl p-2 flex flex-col justify-center shadow-lg h-20 border border-emerald-500/20">
            <a href="https://www.ycjh.hlc.edu.tw/" target="_blank" class="h-full w-full bg-emerald-900/40 hover:bg-emerald-600 rounded-xl flex items-center justify-center gap-3 transition-colors border border-emerald-500/10 px-4 group">
                <div class="bg-emerald-500 p-2 rounded-lg group-hover:scale-110 transition-transform"><i class="fas fa-school text-white"></i></div>
                <span class="text-sm font-black text-white">宜昌國中官網</span>
            </a>
        </div>
    </footer>

</body>
</html>
