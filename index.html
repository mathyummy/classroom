<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>九年八班 數位看板 - 雲端版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="module">
        // --- 1. 統一導入 Firebase SDK ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // --- 2. Firebase 配置 ---
        const firebaseConfig = {
            apiKey: "AIzaSyAfsi-TZ8LrFfZ2Cw6w1DQNTaM_q-oiL-Q",
            authDomain: "classroom-board.firebaseapp.com",
            projectId: "classroom-board",
            storageBucket: "classroom-board.firebasestorage.app",
            messagingSenderId: "802885901626",
            appId: "1:802885901626:web:df25f12cef342c373ac403",
            measurementId: "G-E2Y76K14RM"
        };

        // --- 3. 全域變數 ---
        let app, auth, db, user;
        const appId = "classroom-908-board";

        const DATES = { 
            exam: "2026-01-21", 
            mock: "2026-03-03",
            final: "2026-05-16" 
        };

        const defaultData = {
            marquee: "九年八班雲端看板已啟動！點擊區塊即可編輯內容。",
            marqueeSpeed: "25s",
            homework: "1. 國文講義 P.35-P.40\n2. 英文單字 L5 小考 (明天)\n3. 數學習作 3-1 完工",
            missing: [{ subject: "數學", students: [{id: "03", done: false}, {id: "15", done: false}] }],
            important: "1. 視力檢查：明天 08:30。\n2. 記得帶環保餐具。",
            quote: "「努力不一定成功，但不努力一定很輕鬆。」",
            isMuted: false
        };

        let appData = { ...defaultData };

        // --- 4. 初始化與修復驗證錯誤 ---
        async function startApp() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                console.log("正在嘗試連線至 Firebase...");

                // 監聽權限狀態
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) {
                        console.log("登入成功:", user.uid);
                        const idDisplay = document.getElementById('user-id-display');
                        if (idDisplay) idDisplay.textContent = `ID: ${user.uid.substring(0,6)}`;
                        updateStatusUI("雲端連線成功", "text-emerald-500");
                        setupSync();
                    }
                });

                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && __initial_auth_token.length > 20) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (authError) {
                    console.warn("驗證權杖不匹配，改用預設匿名登入...");
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("系統初始化完全失敗:", error);
                const errorBox = document.createElement('div');
                errorBox.className = "fixed inset-0 bg-red-900/90 flex items-center justify-center z-[100] text-white p-10 text-center";
                errorBox.innerHTML = `<div><i class="fas fa-exclamation-triangle text-5xl mb-4"></i><br>系統啟動失敗<br>錯誤訊息: ${error.message}</div>`;
                document.body.appendChild(errorBox);
            }
        }

        function setupSync() {
            const dataDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'boardConfig', 'mainBoard');
            
            onSnapshot(dataDocRef, (snapshot) => {
                if (snapshot.exists()) {
                    appData = snapshot.data();
                    // 確保 DOM 載入後再進行渲染
                    if (document.readyState === 'complete' || document.readyState === 'interactive') {
                        renderBoard();
                    }
                } else {
                    console.log("找不到雲端存檔，建立預設資料...");
                    setDoc(dataDocRef, defaultData);
                }
            }, (error) => {
                console.error("同步失敗:", error);
                updateStatusUI("同步錯誤", "text-rose-500");
            });
        }

        window.saveToCloud = async (newData) => {
            if (!user) return;
            const dataDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'boardConfig', 'mainBoard');
            try { 
                await updateDoc(dataDocRef, newData); 
            } catch (e) { 
                await setDoc(dataDocRef, newData, { merge: true }); 
            }
        };

        // --- 5. UI 控制 (加入安全檢查防止 Null 錯誤) ---
        function renderBoard() {
            const safeSetText = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.textContent = val || "";
            };

            safeSetText('marquee-content', appData.marquee);
            safeSetText('homework-list', appData.homework);
            safeSetText('important-note', appData.important);
            safeSetText('quote-display', appData.quote);
            
            const mContent = document.getElementById('marquee-content');
            if (mContent) {
                const speed = appData.marqueeSpeed || "25s";
                const speedLabel = document.getElementById('speed-label');
                if (speedLabel) speedLabel.textContent = speed === "0s" ? "停止" : speed === "40s" ? "慢速" : speed === "15s" ? "極快" : "正常";

                if (speed === "0s") {
                    mContent.style.animation = "none";
                    mContent.className = "text-lg font-bold px-4";
                } else {
                    mContent.style.animation = `marquee ${speed} linear infinite`;
                    mContent.className = "animate-marquee text-lg font-bold";
                }
            }
            
            const missingContainer = document.getElementById('missing-container');
            if (missingContainer) {
                missingContainer.innerHTML = '';
                if (!appData.missing || appData.missing.length === 0) {
                    missingContainer.innerHTML = '<div class="text-emerald-400 font-bold text-center py-6">★ 全部交齊 ★</div>';
                } else {
                    appData.missing.forEach((group, gIndex) => {
                        const groupDiv = document.createElement('div');
                        groupDiv.className = "bg-slate-800/60 p-4 rounded-2xl border border-slate-700/50 mb-3";
                        groupDiv.innerHTML = `<div class="text-lg font-black text-orange-300 mb-2 border-b border-orange-500/20 pb-1">${group.subject}</div>`;
                        const list = document.createElement('div');
                        list.className = "flex flex-wrap gap-2 pt-1";
                        group.students.forEach((s, sIndex) => {
                            const tag = document.createElement('div');
                            tag.className = `px-3 py-1 border-2 rounded-lg font-mono font-black text-xl cursor-pointer ${s.done ? 'opacity-20 line-through bg-slate-700 border-transparent' : 'text-orange-100 border-orange-500/40 bg-orange-500/10'}`;
                            tag.textContent = s.id;
                            tag.onclick = (e) => {
                                e.stopPropagation();
                                const updated = JSON.parse(JSON.stringify(appData.missing));
                                updated[gIndex].students[sIndex].done = !updated[gIndex].students[sIndex].done;
                                window.saveToCloud({ missing: updated });
                            };
                            list.appendChild(tag);
                        });
                        groupDiv.appendChild(list);
                        missingContainer.appendChild(groupDiv);
                    });
                }
            }
            updateCountdowns();
            const muteIcon = document.getElementById('mute-icon');
            if (muteIcon) muteIcon.className = appData.isMuted ? 'fas fa-volume-mute text-rose-500' : 'fas fa-volume-up text-emerald-400';
        }

        function updateCountdowns() {
            const calc = (t) => Math.max(0, Math.ceil((new Date(t).setHours(0,0,0,0) - new Date().setHours(0,0,0,0)) / 86400000));
            
            const examEl = document.getElementById('exam-countdown');
            const mockEl = document.getElementById('mock-countdown');
            const finalEl = document.getElementById('final-countdown');
            
            if (examEl) examEl.textContent = calc(DATES.exam);
            if (mockEl) mockEl.textContent = calc(DATES.mock);
            if (finalEl) finalEl.textContent = calc(DATES.final);
        }

        function updateStatusUI(text, colorClass) {
            const el = document.getElementById('sync-status-text');
            if (el) {
                el.textContent = text;
                el.parentElement.className = `flex items-center text-[10px] ${colorClass} font-bold whitespace-nowrap`;
            }
        }

        // 當頁面完全加載後再初始化 Firebase
        window.addEventListener('load', startApp);

        setInterval(() => {
            const now = new Date();
            const clock = document.getElementById('clock-display');
            const date = document.getElementById('date-display');
            if (clock) clock.textContent = now.toLocaleTimeString('zh-TW', {hour12:false});
            if (date) date.textContent = now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        }, 1000);

        window.closeModal = () => document.getElementById('edit-modal').classList.add('hidden');
        window.openModal = (field, title, desc = "") => {
            window.currentEditingField = field;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-desc').innerHTML = desc;
            let val = field === 'missing' ? (appData.missing || []).map(g => `${g.subject}：${g.students.map(s => s.id).join(', ')}`).join(' | ') : (appData[field] || "");
            document.getElementById('modal-input').value = val;
            document.getElementById('edit-modal').classList.remove('hidden');
        };
        window.confirmSave = () => {
            const val = document.getElementById('modal-input').value.trim();
            const update = {};
            if (window.currentEditingField === 'missing') {
                update.missing = val ? val.split('|').map(g => {
                    const parts = g.split(/[：:]/);
                    return { subject: parts[0].trim(), students: (parts[1] || "").split(/[,，\s]+/).filter(x => x).map(id => ({ id: id.trim(), done: false })) };
                }).filter(g => g.students.length > 0) : [];
            } else { update[window.currentEditingField] = val; }
            window.saveToCloud(update);
            window.closeModal();
        };
        window.toggleMarqueeSpeed = (e) => {
            e.stopPropagation();
            const speeds = { "25s": "40s", "40s": "15s", "15s": "0s", "0s": "25s" };
            window.saveToCloud({ marqueeSpeed: speeds[appData.marqueeSpeed || "25s"] });
        };
        window.toggleMute = () => window.saveToCloud({ isMuted: !appData.isMuted });
        window.spin = () => {
            const el = document.getElementById('lucky-num');
            if (!el) return;
            let count = 0;
            const intv = setInterval(() => {
                el.textContent = Math.floor(Math.random() * 25) + 1;
                if (++count > 15) clearInterval(intv);
            }, 80);
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0f172a; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .editable:hover { background: rgba(255,255,255,0.05); cursor: pointer; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .animate-marquee { display: inline-block; white-space: nowrap; }
    </style>
</head>
<body class="p-4 space-y-4">

    <!-- 編輯彈窗 -->
    <div id="edit-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-lg rounded-3xl p-6 shadow-2xl">
            <h3 id="modal-title" class="text-xl font-bold mb-2 text-blue-400">編輯內容</h3>
            <div id="modal-desc" class="text-slate-400 text-xs mb-4"></div>
            <textarea id="modal-input" class="w-full h-40 bg-slate-800 border border-slate-600 rounded-xl p-4 text-white focus:outline-none focus:border-blue-500 text-lg mb-4"></textarea>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3 bg-slate-700 rounded-xl font-bold">取消</button>
                <button onclick="confirmSave()" class="flex-1 py-3 bg-blue-600 rounded-xl font-bold">同步到雲端</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass rounded-2xl p-4 flex flex-col lg:flex-row justify-between items-center shadow-xl border-b-2 border-indigo-500/20">
        <div class="flex items-center space-x-4">
            <div class="bg-indigo-600 p-2 rounded-lg"><i class="fas fa-cloud text-xl"></i></div>
            <div>
                <div class="flex items-center gap-3">
                    <h1 class="text-2xl font-black text-white">九年八班 數位看板</h1>
                    <div class="flex items-center bg-slate-800/80 px-2 py-1 rounded-lg border border-slate-700 gap-2">
                        <span id="user-id-display" class="text-slate-500 text-[10px] font-mono">ID: ...</span>
                        <div class="flex items-center text-[10px] text-slate-500 font-bold whitespace-nowrap">
                            <span id="sync-status-text" class="mr-1.5">正在連線</span>
                            <i class="fas fa-circle text-[6px] animate-pulse"></i>
                        </div>
                    </div>
                </div>
                <div id="date-display" class="text-indigo-300 text-sm font-bold">讀取中...</div>
            </div>
        </div>

        <div class="flex flex-wrap justify-center gap-3 mt-4 lg:mt-0">
            <div class="bg-yellow-500/10 border border-yellow-500/30 px-3 py-1 rounded-xl text-center">
                <div class="text-[10px] text-yellow-500 font-bold">段考倒數</div>
                <div class="text-2xl font-black text-yellow-400"><span id="exam-countdown">--</span><span class="text-xs ml-1">D</span></div>
            </div>
            <!-- 新增一個隱藏的 mock-countdown 以防止程式報錯（如果以後需要顯示可以解除隱藏） -->
            <div id="mock-countdown" class="hidden"></div>
            <div class="bg-orange-600/10 border border-orange-500/30 px-3 py-1 rounded-xl text-center">
                <div class="text-[10px] text-orange-400 font-bold">會考倒數</div>
                <div class="text-2xl font-black text-orange-500"><span id="final-countdown">--</span><span class="text-xs ml-1">D</span></div>
            </div>
            <div class="ml-4 pl-4 border-l border-slate-700 flex flex-col justify-center">
                <span id="clock-display" class="text-3xl font-mono font-black text-indigo-400">00:00:00</span>
            </div>
        </div>
    </header>

    <!-- Marquee -->
    <div onclick="openModal('marquee', '編輯公告')" class="bg-rose-600 rounded-xl h-11 flex items-center overflow-hidden shadow-lg editable group relative">
        <button onclick="toggleMarqueeSpeed(event)" class="bg-rose-950 px-4 h-full flex items-center z-10 border-r border-rose-400/30 shrink-0">
            <span id="speed-label" class="text-[10px] font-black text-white">正常</span>
        </button>
        <div class="flex-1 overflow-hidden relative">
            <div id="marquee-content" class="animate-marquee text-lg font-bold">載入中...</div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="grid grid-cols-1 md:grid-cols-3 gap-4 flex-1 min-h-0">
        <!-- Homework -->
        <section onclick="openModal('homework', '今日聯絡簿')" class="glass rounded-3xl p-6 flex flex-col border-l-8 border-l-yellow-400 editable overflow-hidden">
            <h2 class="text-2xl font-black text-yellow-400 mb-4 flex items-center"><i class="fas fa-edit mr-3"></i> 今日聯絡簿</h2>
            <div id="homework-list" class="text-2xl leading-relaxed whitespace-pre-wrap overflow-y-auto flex-1 font-bold text-slate-100"></div>
            <div onclick="event.stopPropagation(); openModal('quote', '今日佳句')" class="mt-4 p-3 bg-slate-800/50 rounded-xl border border-slate-700/50">
                <span id="quote-display" class="italic text-yellow-300 text-lg font-bold"></span>
            </div>
        </section>

        <!-- Important -->
        <section onclick="openModal('important', '重要提醒')" class="bg-blue-600/20 glass rounded-3xl p-6 flex flex-col border-t-8 border-t-blue-400 editable">
            <h2 class="text-2xl font-black text-blue-300 mb-4 flex items-center"><i class="fas fa-bullhorn mr-3"></i> 重要提醒</h2>
            <div id="important-note" class="text-2xl font-black leading-relaxed whitespace-pre-wrap overflow-y-auto flex-1 text-blue-50"></div>
        </section>

        <!-- Missing -->
        <section class="glass rounded-3xl p-6 flex flex-col border-r-8 border-r-orange-500">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-black text-orange-400"><i class="fas fa-user-times mr-3"></i> 作業未交</h2>
                <button onclick="openModal('missing', '編輯未交', '範例：數學：01, 05 | 英文：12')" class="text-xs bg-slate-700 px-3 py-1 rounded-lg">編輯</button>
            </div>
            <div id="missing-container" class="flex-1 overflow-y-auto"></div>
        </section>
    </main>

    <!-- Footer Tools -->
    <footer class="grid grid-cols-2 md:grid-cols-4 gap-4 shrink-0 pb-2">
        <div class="glass rounded-2xl p-3 flex items-center justify-between shadow-lg h-20">
            <div><p class="text-indigo-400 text-[10px] font-bold">抽籤</p><div id="lucky-num" class="text-4xl font-black">?</div></div>
            <button onclick="spin()" class="bg-indigo-600 p-4 rounded-xl"><i class="fas fa-random text-white"></i></button>
        </div>

        <div class="glass rounded-2xl p-3 flex items-center justify-between shadow-lg h-20">
            <div class="flex-1">
                <div class="flex items-center space-x-2"><p class="text-emerald-400 text-[10px] font-bold">計時</p><button onclick="toggleMute()"><i id="mute-icon" class="fas fa-volume-up text-[10px]"></i></button></div>
                <div id="timer-display" class="text-3xl font-mono font-bold text-emerald-400">05:00</div>
            </div>
            <button class="bg-emerald-600 px-3 py-2 rounded-xl font-bold text-xs">START</button>
        </div>

        <div class="glass rounded-2xl p-2 flex flex-col justify-center shadow-lg h-20">
            <a href="https://padlet.com/teacher133_5/padlet-rmnqtuy0xqgy53qh" target="_blank" class="h-full w-full bg-indigo-900/40 hover:bg-indigo-600 rounded-xl flex items-center justify-center gap-3 transition-colors px-4 group">
                <span class="text-sm font-black text-white">電子布告欄</span>
            </a>
        </div>

        <div class="glass rounded-2xl p-2 flex flex-col justify-center shadow-lg h-20">
            <a href="https://www.ycjh.hlc.edu.tw/" target="_blank" class="h-full w-full bg-emerald-900/40 hover:bg-emerald-600 rounded-xl flex items-center justify-center gap-3 transition-colors px-4 group">
                <span class="text-sm font-black text-white">宜昌國中官網</span>
            </a>
        </div>
    </footer>
</body>
</html>
